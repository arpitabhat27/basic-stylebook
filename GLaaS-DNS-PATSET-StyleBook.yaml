
#
#  ref : TP1-HTTP-LB-MON-StyleBook
# Copyright 2016 Citrix Systems, Inc. All rights reserved.
# This software and documentation contain valuable trade
# secrets and proprietary property belonging to Citrix Systems, Inc.
# None of this software and documentation may be copied,
# duplicated or disclosed without the express
# written permission of Citrix Systems, Inc.
#
--- 
name: GLaaS-DNS-PATSET-StyleBook
description: "This stylebook defines a Tier1 GLaaS LB vip"
display-name: "Tie1 DNS LB vip and patset"
namespace: com.citrix.adc.stylebooks
schema-version: "1.0"
version: "1.1"
import-stylebooks: 
  - 
    namespace: netscaler.nitro.config
    prefix: ns
    version: "10.5"
  - 
    namespace: com.citrix.adc.stylebooks
    prefix: stlb
    version: "1.1"
#parameters-default-sources:
#  - stlb::GLaaS-DNS-TT-LB-StyleBook
parameters: 
  - 
    name: appname
    label: "Load Balanced Application Name"
    description: "Load Balanced Application Name"
    type: string
    key: true
    required: true
    updatable: false
  - 
    name: dns-virtual-ip
    label: "Load Balanced App Virtual IP address"
    description: "this is actually teh dummy vip for CS if it is tier1 "
    type: ipaddress
    required: true
    updatable: false
  - 
    name: svc-servers
    label: "Application Servers IP Addresses"
    description: "List of the IP addresses of the application servers that are members of this Load Balanced application"
    type: "ipaddress[]"
    required: true
    updatable: true
  - 
    name: svc-server-port
    label: "Application Server Port"
    description: "TCP port of the application servers"
    type: tcp-port
    required: true
    updatable: false
    default: 53
  -
    name: dns-servicetype
    label: "Load Balanced App Protocol"
    description: "Protocol used for the Load Balanced application."
    type: string[]
    required: true
    updatable: false
    allowed-values: 
      - DNS
      - DNS_TCP
    default: [DNS]
  -    
    name: domain-names
    label: "Domain Names"
    type: string[]
    required: true
    updatable: true
  - 
    name: lb-advanced
    label: "Advanced Load Balancer Settings"
    type: object
    required: false
    updatable: true
    gui: 
      collapse_pane: true
      columns: 2
    parameters: 
      - 
        name: dns-virtual-port
        label: "Load Balanced App Virtual Port"
        description: "port representing the Load Balanced application"
        type: tcp-port
        required: true
        updatable: false
        default: 53
      - 
        name: lb-algorithm
        label: "Load Balanced App Algorithm"
        type: string
        description: "Load Balancing algorithm for the application"
        required: false
        updatable: true
        default: LEASTCONNECTION
        allowed-values: 
          - LEASTCONNECTION
          - ROUNDROBIN
          - LEASTRESPONSETIME
          - STATICPROXIMITY
          - SOURCEIPHASH        
      - 
        name: lb-persistence
        label: "Load Balanced App Persistence Type"
        description: "Persistence type used for members of this pool"
        type: string
        required: false
        updatable: true
        allowed-values: 
          - NONE
          - SOURCEIP
      - 
        name: lb-clientTimeout
        label: "Load Balanced App Client Timeout"
        description: "Client connection timeout after inactivity in seconds"
        type: number
        required: false
        updatable: true

  - 
    name: svcg-advanced
    label: "Advanced Application Server Settings"
    type: object
    required: false
    updatable: true
    gui: 
      collapse_pane: true
      columns: 2
    parameters: 
      - 
        name: svc-useproxyport
        label: "Service Group UseProxyPort"
        description: "Use the proxy port as the source port when initiating connections with the server."
        type: string
        required: false
        updatable: true
        allowed-values: 
          - "NO"
          - "YES"
      - 
        name: svc-usip
        label: "Preserve Client Source IP (USIP)"
        description: "Use client's IP address as the source IP address when initiating connection to the server."
        type: string
        required: false
        updatable: true
        allowed-values: 
          - "NO"
          - "YES"
      - 
        name: svc-cip
        label: "Service Group CIP"
        description: "Insert the Client IP header in requests forwarded to the service."
        type: string
        required: false
        updatable: true
        allowed-values: 
          - DISABLED
          - ENABLED        
      - 
        name: svc-cipheader
        label: "Service Group CIP Header"
        description: "Name of the HTTP header whose value must be set to the IP address of the client. Used with the Client IP parameter. "        
        type: string
        required: false
        updatable: true
components: 
  - 
    name: dns-lb
    type: "stlb::GLaaS-DNS-TT-LB-StyleBook"
    repeat: $parameters.dns-servicetype
    repeat-item: dnsproto
    repeat-index: index
    properties:
      lb-advanced: 
        lb-algorithm?: $parameters.lb-advanced.lb-algorithm
        lb-clientTimeout?: $parameters.lb-advanced.lb-clientTimeout
        lb-persistence?: $parameters.lb-advanced.lb-persistence
      lb-appname: $parameters.appname + "_" + str($index)
      lb-servicetype: $dnsproto
      lb-virtual-ip: $parameters.dns-virtual-ip
      lb-virtual-port: $parameters.lb-advanced.dns-virtual-port
      svc-server-port: $parameters.svc-server-port
      svc-servers: $parameters.svc-servers
      svc-servicegroupname?: $parameters.appname + "_" + str($index) + "_svcgrp"
      svc-servicetype?: $dnsproto
      svcg-advanced: 
        svc-useproxyport?: $parameters.svcg-advanced.svc-useproxyport
        svc-usip?: $parameters.svcg-advanced.svc-usip
    components:
      -
       name: dns_patset
       type: "ns::policypatset"
       properties:
         name: $parameters.appname + "_" + str($index) + "_patset"
       components:
         -
           name: dns_patset_bindings
           type: ns::policypatset_pattern_binding
           repeat: $parameters.domain-names
           repeat-item: domain_iter
           properties:
             name: $parent.properties.name
             String: $domain_iter