---
name: GLaaS-StyleBook
description: This StyleBook defines the configuration for GSLB as a service deployment
display-name: GSLB as a Service StyleBook
namespace: com.citrix.saas.stylebooks
version: "1.0"
schema-version: "1.0"
import-stylebooks: 
  - 
    namespace: netscaler.nitro.config
    prefix: ns
    version: "10.5"
parameters:
  -
    name: saas-name
    label: "Service Name"
    description: "Service Name"
    type: string
    key: true
    required: true
    updatable: false
  -
    name: domain-name
    label: "Domain Name"
    description: "Domain Name"
    type: string
    key: true
    required: true
    updatable: false
  -
    name: ttl
    label: "TTL for the Domain"
    description: "TTL for the domain"
    type: number
    key: true
    default: 30
    required: true
    updatable: false
  -
    name: lb-algorithm
    label: "LB Algorithm"
    description: "Load Balancing Algorithm"
    type: string
    required: true
    updatable: false
    default: ROUNDROBIN
    allowed-values: 
      - ROUNDROBIN
      - STATICPROXIMITY
      - SOURCEIPHASH 
  - 
    name: lbmonitor
    label: "LB Monitor"
    description: "Monitor to be bound to the GSLB service (optional)"
    type: object
    required: false
    updatable: true
    parameters:
      - 
        name: mon-name
        label: "LB Monitor Name"
        description: "Name of the monitor"
        type: string
        required: true
        updatable: false
      - 
        name: mon-respcode
        label: "LB Monitor Response Code"
        description: "LB Monitor Response Code"
        type: string
        required: true
        updatable: false
      - 
        name: mon-httprequest
        label: "LB Monitor HTTP Request"
        description: "LB Monitor HTTP Request"
        type: string
        required: true
        updatable: false
  - 
    name: site-ip
    label: "GSLB Site IP"
    description: "GSLB Site IP Address"
    type: ipaddress
    required: true
    updatable: true
  - 
    name: services
    label: "GSLB Services"
    description: "GSLB Service Information"
    type: object[]
    required: true
    updatable: true
    parameters:
      - 
        name: svc-name
        label: "GSLB Service Name"
        description: "Name of the GSLB Service"
        type: string
        required: true
        updatable: false
      -
        name: svc-ip
        label: "GSLB Service IP"
        description: "GSLB Service IP"
        type: ipaddress
        required: true
        updatable: true
      - 
        name: svc-port
        label: "GSLB Service Port"
        description: "GSLB Service Port"
        type: tcp-port
        required: true
        updatable: false
components:
  -
    name: lb_monitor
    type: ns::lbmonitor
    condition: $parameters.lbmonitor
    properties:
      monitorname: $parameters.lbmonitor.mon-name + '-mon'
      type: HTTP
      respcode: [ $parameters.lbmonitor.mon-respcode ]
      httprequest: $parameters.lbmonitor.mon-httprequest
  - 
    name: gslb_vserver
    type: ns::gslbvserver
    properties:
      name: $parameters.saas-name + '-gslb_vs'
      servicetype: HTTP
      lbmethod?: $parameters.lb-algorithm
    components:
      -
        name: gslb_domain
        type: ns::gslbvserver_domain_binding
        properties:
          name: $parent.properties.name
          domainname: $parameters.domain-name
          ttl: $parameters.ttl
      -
        name: gslb_site
        type: ns::gslbsite
        properties:
          sitename: GSLBSITE
          siteipaddress: $parameters.site-ip
          publicip: $parameters.site-ip
        components:
          -
            name: gslb_service
            type: ns::gslbservice
            repeat: $parameters.services
            repeat-item: svc
            properties:
              servicename: $svc.svc-name + '-svc'
              ip: $svc.svc-ip
              servicetype: HTTP
              port: $svc.svc-port
              publicip: $svc.svc-ip
              publicport: $svc.svc-port
              sitename: $parent.properties.sitename
            components:
              - 
                name: gslb_service_mon_binding
                type: ns::gslbservice_lbmonitor_binding
                condition: $parameters.lbmonitor
                properties:
                  servicename: $parent.properties.servicename
                  monitor_name: $components.lb_monitor.properties.monitorname
              -
                name: gslb_vserver_service_binding
                type: ns::gslbvserver_gslbservice_binding
                properties:
                  name: $parent.parent.parent.properties.name
                  servicename: $parent.properties.servicename    
outputs:
  -
    name: gsvserver
    value: $components.gslb_vserver
